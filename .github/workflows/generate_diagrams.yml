name: Generate PlantUML Diagrams

# Kích hoạt workflow khi có push lên main/master
# VÀ chỉ khi file trong đường dẫn 'docs/diagrams/src/' thay đổi
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'docs/diagrams/src/**.plantuml'

# Cấp quyền cho Action để "viết" (commit) file ảnh vào repo
permissions:
  contents: write
  pull-requests: write

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    
    steps:
      # Bước 1: Checkout code từ repo về máy ảo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Bước 2: Chạy action, đọc file .plantuml và tạo ra file .png
      - name: Generate diagram
        uses: 'cloud-bees/plantuml-github-action@v2'
        with:
          # Chỉ định file nguồn
          source: 'docs/diagrams/src/use_case_diagram.plantuml'
          # Chỉ định nơi xuất file ảnh
          output: 'docs/diagrams/generated/use_case_diagram.png'

      # Bước 3: Tự động commit file ảnh .png vừa tạo
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci(docs): Auto-generate diagrams"
          # Chỉ commit các file .png trong thư mục generated
          file_pattern: 'docs/diagrams/generated/*.png'