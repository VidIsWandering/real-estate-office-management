
> backend@1.0.0 test
> NODE_ENV=test jest --coverage --maxWorkers=1 --forceExit

  console.log
    Test database connected

      at log (src/__tests__/helpers/db.helper.js:38:13)

2026-01-12 21:00:38 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:38 +0000] "POST /api/v1/auth/login HTTP/1.1" 200 851 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:39 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:39 +0000] "POST /api/v1/auth/login HTTP/1.1" 500 439 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:40 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:40 +0000] "POST /api/v1/auth/login HTTP/1.1" 400 112 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:41 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:41 +0000] "GET /api/v1/auth/profile HTTP/1.1" 200 385 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:42 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:42 +0000] "GET /api/v1/auth/profile HTTP/1.1" 401 47 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:43 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:43 +0000] "PUT /api/v1/auth/profile HTTP/1.1" 200 423 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:44 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:44 +0000] "PUT /api/v1/auth/profile HTTP/1.1" 200 384 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:45 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:45 +0000] "PUT /api/v1/auth/profile HTTP/1.1" 400 109 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:45 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:45 +0000] "PUT /api/v1/auth/profile HTTP/1.1" 401 47 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:46 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:46 +0000] "PUT /api/v1/auth/change-password HTTP/1.1" 200 109 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:46 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:46 +0000] "POST /api/v1/auth/login HTTP/1.1" 200 851 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:47 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:47 +0000] "PUT /api/v1/auth/change-password HTTP/1.1" 500 459 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:48 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:48 +0000] "PUT /api/v1/auth/change-password HTTP/1.1" 400 122 "-" "-" {"service":"real-estate-api"}
FAIL src/__tests__/integration/auth.api.test.js (11.419 s)
  Auth API Integration Tests
    POST /api/v1/auth/login
      âœ“ should login successfully with valid credentials (761 ms)
      âœ• should return 401 with invalid credentials (752 ms)
      âœ“ should return 400 with missing fields (1016 ms)
    GET /api/v1/auth/profile
      âœ“ should return profile for authenticated user (996 ms)
      âœ“ should return 401 without token (975 ms)
    PUT /api/v1/auth/profile
      âœ“ should update profile successfully (916 ms)
      âœ“ should update preferences successfully (977 ms)
      âœ“ should return 400 with invalid email format (945 ms)
      âœ“ should return 401 without token (802 ms)
    PUT /api/v1/auth/change-password
      âœ“ should change password successfully (928 ms)
      âœ• should return 400 with incorrect old password (770 ms)
      âœ“ should return 400 with password mismatch (737 ms)

  â— Auth API Integration Tests â€º POST /api/v1/auth/login â€º should return 401 with invalid credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      59 |         .expect(500); // Error middleware returns 500 by default
      60 |
    > 61 |       expect(response.body.success).toBe(false);
         |                                     ^
      62 |     });
      63 |
      64 |     it('should return 400 with missing fields', async () => {

      at Object.toBe (src/__tests__/integration/auth.api.test.js:61:37)

  â— Auth API Integration Tests â€º PUT /api/v1/auth/change-password â€º should return 400 with incorrect old password

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      205 |         .expect(500); // Service throws error
      206 |
    > 207 |       expect(response.body.success).toBe(false);
          |                                     ^
      208 |     });
      209 |
      210 |     it('should return 400 with password mismatch', async () => {

      at Object.toBe (src/__tests__/integration/auth.api.test.js:207:37)

  console.log
    Test database connected

      at log (src/__tests__/helpers/db.helper.js:38:13)

2026-01-12 21:00:49 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:49 +0000] "GET /api/v1/system/config HTTP/1.1" 200 347 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:50 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:50 +0000] "GET /api/v1/system/config HTTP/1.1" 200 347 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:50 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:50 +0000] "GET /api/v1/system/config HTTP/1.1" 403 80 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:51 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:51 +0000] "GET /api/v1/system/config HTTP/1.1" 401 47 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:52 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:52 +0000] "PUT /api/v1/system/config HTTP/1.1" 200 364 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:53 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:53 +0000] "PUT /api/v1/system/config HTTP/1.1" 200 355 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:53 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:53 +0000] "GET /api/v1/system/config HTTP/1.1" 200 357 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:54 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:54 +0000] "PUT /api/v1/system/config HTTP/1.1" 403 80 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:54 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:54 +0000] "PUT /api/v1/system/config HTTP/1.1" 403 80 "-" "-" {"service":"real-estate-api"}
2026-01-12 21:00:55 [[32minfo[39m]: ::ffff:127.0.0.1 - - [12/Jan/2026:14:00:55 +0000] "PUT /api/v1/system/config HTTP/1.1" 401 47 "-" "-" {"service":"real-estate-api"}
PASS src/__tests__/integration/system-config.api.test.js (7.319 s)
  System Config API Integration Tests
    GET /api/v1/system/config
      âœ“ should return system config for admin (787 ms)
      âœ“ should return system config for manager (769 ms)
      âœ“ should return 403 for agent (not authorized) (782 ms)
      âœ“ should return 401 without token (771 ms)
    PUT /api/v1/system/config
      âœ“ should update system config for admin (857 ms)
      âœ“ should persist config changes (813 ms)
      âœ“ should return 403 for manager (not admin) (771 ms)
      âœ“ should return 403 for agent (795 ms)
      âœ“ should return 401 without token (771 ms)

  console.log
    Test database connected

      at log (src/__tests__/helpers/db.helper.js:38:13)

PASS src/__tests__/unit/system-config.repository.test.js (8.856 s)
  SystemConfigRepository
    getAll
      âœ“ should return all configurations (804 ms)
    getByKey
      âœ“ should return config by key (832 ms)
      âœ“ should return null for non-existent key (776 ms)
    update
      âœ“ should update existing config (774 ms)
      âœ“ should return null for non-existent key (784 ms)
    upsert
      âœ“ should insert new config (1876 ms)
      âœ“ should update existing config on conflict (2214 ms)
    getMergedConfig
      âœ“ should merge all configs into single object (762 ms)

PASS src/__tests__/smoke.test.js
  Smoke test
    âœ“ should always pass (1 ms)

PASS src/__tests__/unit/auth.service.test.js
  AuthService
    register
      âœ“ should create account and staff successfully (2 ms)
      âœ“ should throw error if username exists (8 ms)
      âœ“ should throw error if email exists (1 ms)
    login
      âœ“ should login successfully with valid credentials (3 ms)
      âœ“ should throw error with invalid username
      âœ“ should throw error with invalid password
      âœ“ should throw error if staff is not active
    updateProfile
      âœ“ should update profile successfully (1 ms)
      âœ“ should throw error if email already exists
    changePassword
      âœ“ should change password successfully (1 ms)
      âœ“ should throw error if old password is incorrect

------------------------------|---------|----------|---------|---------|----------------------------
File                          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s          
------------------------------|---------|----------|---------|---------|----------------------------
All files                     |   62.34 |    35.79 |   28.17 |   62.57 |                            
 src                          |   85.71 |       50 |      25 |   85.71 |                            
  app.js                      |   85.71 |       50 |      25 |   85.71 | 49,83-84,93,105            
 src/controllers              |   33.05 |        8 |    9.83 |   33.05 |                            
  appointment.controller.js   |      25 |        0 |       0 |      25 | 15-70,81-85                
  auth.controller.js          |   74.07 |      100 |   66.66 |   74.07 | 12-14,53-56,63,70          
  client.controller.js        |      20 |        0 |       0 |      20 | 15-90,102-108              
  contract.controller.js      |   18.51 |        0 |       0 |   18.51 | 14-103,114-120             
  real-estate.controller.js   |   18.51 |        0 |       0 |   18.51 | 15-99,110-117              
  report.controller.js        |   33.33 |      100 |       0 |   33.33 | 16-81,104-111              
  staff.controller.js         |   21.73 |        0 |       0 |   21.73 | 16-93,104-110              
  system.controller.js        |    60.6 |       50 |   28.57 |    60.6 | 16-18,93-132,139,142-145   
  transaction.controller.js   |   21.73 |        0 |       0 |   21.73 | 14-83,94-99                
  voucher.controller.js       |   22.72 |        0 |       0 |   22.72 | 14-81,96-101               
 src/middlewares              |   44.57 |    27.77 |   66.66 |   44.57 |                            
  auth.middleware.js          |   64.51 |    53.33 |      75 |   64.51 | 39,50,54,72-90             
  error.middleware.js         |   20.45 |        0 |      50 |   20.45 | 14-16,24-89                
  validate.middleware.js      |     100 |      100 |     100 |     100 |                            
 src/models                   |   94.73 |       50 |      80 |   94.73 |                            
  account.model.js            |   85.71 |      100 |   66.66 |   85.71 | 28                         
  staff.model.js              |     100 |       50 |     100 |     100 | 16                         
 src/repositories             |   49.54 |    34.04 |   61.11 |   50.94 |                            
  account.repository.js       |   55.55 |       50 |      50 |    62.5 | 13-19,52-56,78-84          
  staff.repository.js         |   25.86 |     12.9 |   42.85 |   25.86 | 13-34,48,58-90,138,148-196 
  system-config.repository.js |     100 |       90 |     100 |     100 | 87                         
 src/routes                   |     100 |      100 |     100 |     100 |                            
  appointment.route.js        |     100 |      100 |     100 |     100 |                            
  auth.route.js               |     100 |      100 |     100 |     100 |                            
  client.route.js             |     100 |      100 |     100 |     100 |                            
  contract.route.js           |     100 |      100 |     100 |     100 |                            
  index.route.js              |     100 |      100 |     100 |     100 |                            
  real-estate.route.js        |     100 |      100 |     100 |     100 |                            
  report.route.js             |     100 |      100 |     100 |     100 |                            
  staff.route.js              |     100 |      100 |     100 |     100 |                            
  system.route.js             |     100 |      100 |     100 |     100 |                            
  transaction.route.js        |     100 |      100 |     100 |     100 |                            
  voucher.route.js            |     100 |      100 |     100 |     100 |                            
 src/services                 |   90.47 |    78.12 |   83.33 |   90.47 |                            
  auth.service.js             |   90.47 |    78.12 |   83.33 |   90.47 | 79,114,119,144,183,210     
 src/utils                    |   69.73 |    17.85 |   68.75 |   69.73 |                            
  bcrypt.util.js              |   85.71 |      100 |     100 |   85.71 | 20,35                      
  jwt.util.js                 |   48.27 |        0 |      60 |   48.27 | 19,34,47-53,63-72,82       
  logger.util.js              |     100 |       50 |     100 |     100 | 26-68                      
  response.util.js            |      70 |    14.28 |    62.5 |      70 | 29,51-60,81                
 src/validators               |     100 |      100 |     100 |     100 |                            
  auth.validator.js           |     100 |      100 |     100 |     100 |                            
------------------------------|---------|----------|---------|---------|----------------------------
Jest: "global" coverage threshold for statements (70%) not met: 62.34%
Jest: "global" coverage threshold for branches (60%) not met: 35.79%
Jest: "global" coverage threshold for lines (70%) not met: 62.57%
Jest: "global" coverage threshold for functions (60%) not met: 28.17%
Test Suites: 1 failed, 4 passed, 5 total
Tests:       2 failed, 39 passed, 41 total
Snapshots:   0 total
Time:        27.821 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
