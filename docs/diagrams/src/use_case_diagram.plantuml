@startuml Use Case Diagram
!theme vibrant
left to right direction
skinparam packageStyle rectangle

' Actors
actor "Quản lý" as Manager
actor "NV Môi giới" as Agent
actor "NV Pháp lý" as Legal
actor "NV Kế toán" as Accountant

' System Boundary
rectangle "Hệ thống Quản lý BĐS" as System {
    
    ' Package: Quản lý Chung
    package "Quản lý Chung" {
        (Đăng nhập Hệ thống) as UC_Login
        (Quản lý Hồ sơ Nhân viên) as UC_Manage_Staff
        (Phân quyền Người dùng) as UC_Manage_Permissions
        (Xem Nhật ký Hoạt động) as UC_View_Logs
        (Cấu hình Hệ thống) as UC_Config_System
    }

    ' Package: Quản lý Nghiệp vụ
    package "Quản lý Nghiệp vụ" {
        (Quản lý Hồ sơ Đối tác) as UC_Manage_Partner
        (Tiếp nhận Bất động sản) as UC_Add_Property
        (Thẩm định Pháp lý BĐS) as UC_Validate_Property
        (Lập Lịch hẹn) as UC_Create_Appointment
        (Cập nhật Trạng thái Lịch hẹn) as UC_Update_Appointment
        (Xem Lịch hẹn) as UC_View_Appointment
    }
    
    ' Package: Quản lý Giao dịch
    package "Quản lý Giao dịch" {
        (Khởi tạo Giao dịch) as UC_Create_Transaction
        (Cập nhật/Hủy Giao dịch) as UC_Update_Transaction
        (Soạn thảo Hợp đồng) as UC_Create_Contract
        (Cập nhật Trạng thái Hợp đồng) as UC_Update_Contract
    }

    ' Package: Quản lý Tài chính
    package "Quản lý Tài chính" {
        (Ghi nhận Thanh toán) as UC_Log_Payment
        (Theo dõi Công nợ) as UC_Track_Debt
    }
    
    ' Package: Báo cáo & Thống kê
    package "Báo cáo" {
        (Lập Báo cáo Doanh thu) as UC_Report_Revenue
        (Lập Báo cáo Hiệu suất NV) as UC_Report_Performance
        (Lập Báo cáo Tình trạng BĐS) as UC_Report_Property
        (Lập Báo cáo Tài chính) as UC_Report_Finance
    }
}

' --- Mối quan hệ giữa Actors và Use Cases ---

' Quản lý
Manager --> UC_Login
Manager --> UC_Manage_Staff
Manager --> UC_Manage_Permissions
Manager --> UC_View_Logs
Manager --> UC_Config_System
Manager --> UC_View_Appointment
Manager --> UC_Report_Revenue
Manager --> UC_Report_Performance
Manager --> UC_Report_Property
Manager --> UC_Report_Finance

' NV Môi giới
Agent --> UC_Login
Agent --> UC_Manage_Partner
Agent --> UC_Add_Property
Agent --> UC_Create_Appointment
Agent --> UC_Update_Appointment
Agent --> UC_View_Appointment
Agent --> UC_Create_Transaction
Agent --> UC_Update_Transaction
Agent --> UC_Report_Property ' (Theo QĐ8, Môi giới xem được báo cáo hiệu suất của chính mình)
' Nếu Report_Performance là báo cáo tổng hợp -> chỉ Manager thấy
' Nếu Report_Property là báo cáo chung -> Môi giới cũng được xem

' NV Pháp lý
Legal --> UC_Login
Legal --> UC_Validate_Property
Legal --> UC_Create_Contract
Legal --> UC_Update_Contract

' NV Kế toán
Accountant --> UC_Login
Accountant --> UC_Log_Payment
Accountant --> UC_Track_Debt
Accountant --> UC_Report_Revenue
Accountant --> UC_Report_Finance

' --- Mối quan hệ <<include>> và <<extend>> ---

' Extend: Khi nhập BĐS, nếu chủ sở hữu chưa có, MỚI cần tạo đối tác.
(UC_Add_Property) ..> (UC_Manage_Partner) : <<extend>>

' Include: Chức năng Theo dõi Công nợ phải bao gồm cả chức năng Ghi nhận Thanh toán.
(UC_Track_Debt) ..> (UC_Log_Payment) : <<include>>

@enduml

' Kích hoạt CI lần đầu sau khi sửa lỗi
' Kích hoạt CI sau khi đổi action
' Trigger CI after total fix